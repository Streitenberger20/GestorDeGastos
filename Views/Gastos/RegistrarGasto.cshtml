@model GestorDeGastos.ViewModels.GastoViewModel

<h2>Nuevo Gasto</h2>

<div class="row">
  <div class="col">
    <h3>Registrar Gasto</h3>
<form id="registrarGasto" asp-controller="Gastos" asp-action="RegistrarGasto" method="post">
    <div class="form-group">
        <label>Fecha</label>
        <input asp-for="FechaGasto" type="date" class="form-control"
               max="@DateTime.Today.ToString("yyyy-MM-dd")" />
        <span asp-validation-for="FechaGasto" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Importe</label>
        <input id="ImporteFormateado" type="text" class="form-control" required />
        <input type="hidden" id="Importe" name="Importe" />
        <span asp-validation-for="Importe" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Moneda</label>
        <select asp-for="Moneda" class="form-control">
            <option value="AR$">AR$</option>
            <option value="USD">USD</option>
        </select>
        <span asp-validation-for="Moneda" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Rubro</label>
        <select asp-for="RubroId" asp-items="ViewBag.Rubros" class="form-control" id="RubroId"></select>
        <span asp-validation-for="RubroId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label>Detalle</label>
        <select asp-for="DetalleId" class="form-control" id="DetalleId"></select>
        <span asp-validation-for="DetalleId" class="text-danger"></span>
    </div>

    <button type="button" class="btn btn-primary" onclick="mostrarConfirmacion()">Guardar</button>
</form>
</div>

    <div class="col">
        <h3>Últimos gastos</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Importe</th>
                    <th>Moneda</th>
                    <th>Rubro</th>
                    <th>Detalle</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var gasto in ViewBag.UltimosGastos)
                {
                    <tr>
                        <td>@gasto.FechaGasto.ToShortDateString()</td>
                        <td>@gasto.Importe.ToString("N2")</td>
                        <td>@gasto.Moneda</td>
                        <td>@gasto.Rubro.NombreRubro</td>
                        <td>@gasto.Detalle.NombreDetalle</td>
                        <td>
                            <button type="button"
                                    class="btn btn-danger btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#confirmarEliminarGastoModal"
                                    data-id="@gasto.Id"
                                    data-detalle="@gasto.Detalle.NombreDetalle">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>



<!-- Modal de Confirmación de registro gasto -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar gasto</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ¿Está seguro que desea registrar este gasto con los datos ingresados?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarFormulario()">Aceptar</button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal de confirmación eliminar gasto -->
    <div class="modal fade" id="confirmarEliminarGastoModal" tabindex="-1" aria-labelledby="modalGastoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalGastoLabel">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    ¿Está seguro que desea eliminar el gasto: <strong id="gastoAEliminar"></strong>?
                </div>
                <div class="modal-footer">
                    <form id="formEliminarGasto" method="post" asp-action="EliminarGasto" asp-controller="Gastos">
                        <input type="hidden" name="id" id="gastoIdEliminar" />
                        <button type="submit" class="btn btn-danger">Sí</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.6.0/dist/autoNumeric.min.js"></script>
    <script>

        // Función para cargar los detalles desde el servidor
        function cargarDetalles(rubroId, detalleSeleccionadoId = null) {
            fetch('/Gastos/ObtenerDetalles?rubroId=' + rubroId)
                .then(response => response.json())
                .then(data => {
                    const detalleSelect = document.getElementById("DetalleId");
                    detalleSelect.innerHTML = "";

                    data.forEach(function (item) {
                        const option = document.createElement("option");
                        option.value = item.id;
                        option.text = item.nombreDetalle;

                        // Selecciona el detalle si coincide con el valor del modelo
                        if (detalleSeleccionadoId && item.id == detalleSeleccionadoId)
                            option.selected = true;

                        detalleSelect.appendChild(option);
                    });
                });
        }

        // Evento al cambiar el rubro
        document.getElementById("RubroId").addEventListener("change", function () {
            const rubroId = this.value;
            cargarDetalles(rubroId);
        });

        // Carga inicial al renderizar la vista
        window.addEventListener("DOMContentLoaded", function () {
            const rubroId = document.getElementById("RubroId").value;
            const detalleSeleccionado = '@Model.DetalleId';
            if (rubroId) {
                cargarDetalles(rubroId, detalleSeleccionado);
            }
        });
       
        //acciones modal eliminar gastos
        var confirmarEliminarGastoModal = document.getElementById('confirmarEliminarGastoModal');
        confirmarEliminarGastoModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var gastoId = button.getAttribute('data-id');
            var gastoDetalle = button.getAttribute('data-detalle');

            document.getElementById('gastoAEliminar').textContent = gastoDetalle;
            document.getElementById('gastoIdEliminar').value = gastoId;
        });


        // Formateo del importe
          const an = new AutoNumeric('#ImporteFormateado', {
            digitGroupSeparator: '.',
            decimalCharacter: ',',
            decimalCharacterAlternative: '.',
            decimalPlaces: 2,
            unformatOnSubmit: true,
            modifyValueOnWheel: false
        });

        document.getElementById('ImporteFormateado').addEventListener('input', function () {
            const raw = an.getNumericString().replace('.', ',');
            console.log('Valor sin formato:', raw);
            document.getElementById('Importe').value = raw;
        });

        function mostrarConfirmacion() {
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        function enviarFormulario() {
            document.getElementById('registrarGasto').submit();
        }

    </script>
}